name: Weekly Legislative Summary

on:
  schedule:
    # Run every Sunday at 6:00 AM UTC (midnight Central Time)
    - cron: "0 6 * * 0"
  workflow_dispatch:  # Allow manual trigger

permissions:
  contents: write

jobs:
  generate-summary:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Ollama
        run: |
          echo "Installing Ollama..."
          curl -fsSL https://ollama.ai/install.sh | sh
          
          # Start Ollama service in background
          echo "Starting Ollama service..."
          ollama serve &
          
          # Wait for Ollama to be ready
          echo "Waiting for Ollama to be ready..."
          for i in {1..30}; do
            if ollama list >/dev/null 2>&1; then
              echo "Ollama is ready!"
              break
            fi
            echo "Waiting... ($i/30)"
            sleep 2
          done

      - name: Pull phi3:mini model
        run: |
          echo "Pulling phi3:mini model..."
          ollama pull phi3:mini
          
          # Verify model is available
          echo "Verifying model..."
          ollama list

      - name: Generate weekly summary
        run: |
          echo "Generating weekly summary..."
          python scripts/generate_weekly_summary.py

      - name: Check for changes
        id: check_changes
        run: |
          if [ -f "data/weekly_summary.json" ]; then
            # Check if the file has meaningful changes (not just timestamp)
            git diff --quiet data/weekly_summary.json 2>/dev/null || echo "changes=true" >> $GITHUB_OUTPUT
          else
            echo "No summary file generated"
            exit 1
          fi

      - name: Commit and push changes
        if: steps.check_changes.outputs.changes == 'true'
        run: |
          git config user.name "civicwatch-bot"
          git config user.email "actions@github.com"
          
          git add data/weekly_summary.json
          
          # Get week range for commit message
          WEEK_START=$(python -c "import json; d=json.load(open('data/weekly_summary.json')); print(d['week_start'])")
          WEEK_END=$(python -c "import json; d=json.load(open('data/weekly_summary.json')); print(d['week_end'])")
          
          git commit -m "Weekly legislative summary: ${WEEK_START} to ${WEEK_END}" || echo "No changes to commit"
          git push

      - name: Summary status
        if: always()
        run: |
          if [ -f "data/weekly_summary.json" ]; then
            echo "Weekly summary generated successfully"
            echo ""
            echo "Summary file contents:"
            echo "====================="
            python -c "import json; d=json.load(open('data/weekly_summary.json')); print(f'Week: {d[\"week_start\"]} to {d[\"week_end\"]}'); print(f'Model: {d[\"model\"]}'); [print(f'{j[\"name\"]}: ' + ', '.join(f'{s[\"title\"]} ({s.get(\"bill_count\", 0)} bills)' for s in j['sections'])) for j in d['jurisdictions']]"
          else
            echo "Weekly summary generation failed"
            exit 1
          fi
