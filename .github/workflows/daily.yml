name: CivicWatch Update

on:
  schedule:
    - cron: "30 * * * *"  # Every hour at :30 (so it hits 00:30 UTC for email)
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install feedparser pyyaml requests

      - name: Fetch feeds
        run: python src/processing/fetch_feeds.py

      - name: Fetch Kansas Legislature RSS feeds
        run: python src/processing/fetch_kansas_rss.py

      - name: Fetch Congress API legislation
        env:
          CONGRESS_API_KEY: ${{ secrets.CONGRESS_API_KEY }}
        run: |
          if [ -n "$CONGRESS_API_KEY" ]; then
            python src/processing/fetch_congress_api.py
          else
            echo "CONGRESS_API_KEY not set, skipping Congress API fetch"
          fi

      - name: Fetch Congressional hearings
        env:
          CONGRESS_API_KEY: ${{ secrets.CONGRESS_API_KEY }}
        run: |
          if [ -n "$CONGRESS_API_KEY" ]; then
            python src/processing/fetch_hearings.py || echo "Hearings fetch failed, continuing..."
          else
            echo "CONGRESS_API_KEY not set, skipping hearings fetch"
          fi

      - name: Build HTML digest
        run: python src/processing/summarize.py

      - name: Generate weekly overview (Fridays at 11pm Central, or if >6 days old)
        env:
          ELEVENLABS_API_KEY: ${{ secrets.ELEVENLABS_API_KEY }}
        run: |
          # Generate weekly overview on:
          # 1. Manual trigger (workflow_dispatch) - always generate
          # 2. Fridays at 11pm Central (Saturday 4-6am UTC)
          # 3. OR if last summary is more than 6 days old (catch-up)
          
          # Check if this is a manual trigger
          IS_MANUAL_TRIGGER=false
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            IS_MANUAL_TRIGGER=true
            echo "Manual trigger detected - will generate weekly overview"
          fi
          
          CURRENT_DAY=$(date -u +%u)  # 1=Monday, 6=Saturday
          CURRENT_HOUR=$(date -u +%H)
          CURRENT_HOUR_NUM=$((10#$CURRENT_HOUR))  # Convert to number for comparison
          
          # Check if it's the scheduled time (Saturday 4-6am UTC = Friday 11pm Central)
          IS_SCHEDULED_TIME=false
          if [ "$CURRENT_DAY" = "6" ] && [ $CURRENT_HOUR_NUM -ge 4 ] && [ $CURRENT_HOUR_NUM -le 6 ]; then
            IS_SCHEDULED_TIME=true
            echo "Scheduled time detected: Friday 11pm Central / Saturday $CURRENT_HOUR:00 UTC"
          fi
          
          # Check if last summary is more than 5 days old (weekly = 7 days, so 5+ means overdue)
          NEEDS_UPDATE=false
          if [ -f "docs/weekly/latest.json" ]; then
            LAST_GENERATED=$(python3 -c "import json, sys; data=json.load(open('docs/weekly/latest.json')); print(data.get('generated_at', ''))" 2>/dev/null || echo "")
            if [ -n "$LAST_GENERATED" ]; then
              DAYS_OLD=$(python3 -c "from datetime import datetime, timezone; last=datetime.fromisoformat('$LAST_GENERATED'.replace('Z', '+00:00')); now=datetime.now(timezone.utc); print(int((now-last).total_seconds()/86400))" 2>/dev/null || echo "0")
              if [ "$DAYS_OLD" -ge 5 ]; then
                NEEDS_UPDATE=true
                echo "Last summary is $DAYS_OLD days old (threshold: 5 days) - generating update"
              else
                echo "Last summary is $DAYS_OLD days old - within threshold (will wait for scheduled time)"
              fi
            else
              echo "Could not parse last generation date - will generate to be safe"
              NEEDS_UPDATE=true
            fi
          else
            echo "No existing weekly summary found - will generate"
            NEEDS_UPDATE=true
          fi
          
          if [ "$IS_MANUAL_TRIGGER" = "true" ] || [ "$IS_SCHEDULED_TIME" = "true" ] || [ "$NEEDS_UPDATE" = "true" ]; then
            echo "Generating weekly overview..."
            # Debug: Check if secret is set (without exposing it)
            if [ -z "$ELEVENLABS_API_KEY" ]; then
              echo "Warning: ELEVENLABS_API_KEY secret is not set or empty"
            else
              echo "ELEVENLABS_API_KEY is set (length: ${#ELEVENLABS_API_KEY} characters)"
            fi
            python -m src.processing.weekly_overview || echo "Weekly overview generation failed, continuing..."
          else
            echo "Skipping weekly overview (not scheduled time and summary is recent)"
            echo "Current day: $CURRENT_DAY, Current hour: $CURRENT_HOUR"
          fi

      # Note: Daily email is now handled by separate workflow (.github/workflows/daily_email.yml
      # This keeps email sending independent from site updates

      - name: Commit updated site
        run: |
          git config user.name "civicwatch-bot"
          git config user.email "actions@github.com"
          git add docs src/output
          git commit -m "Automated CivicWatch update" || echo "No changes"
          git push
